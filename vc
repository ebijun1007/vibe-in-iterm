#!/usr/bin/env bash
set -e

# Check if running in iTerm
if [ "$TERM_PROGRAM" != "iTerm.app" ]; then
  echo "[error] This command only works in iTerm.app"
  exit 1
fi

# Get current working directory
WORKDIR="$PWD"

CODEX_HOME="$WORKDIR/.codex"
env_exports=()

echo "[done] Workspace prepared for: $WORKDIR"

# Build shared environment exports for the iTerm panes
env_exports+=("CODEX_HOME=$CODEX_HOME")

env_prefix=""
for entry in "${env_exports[@]}"; do
  key=${entry%%=*}
  val=${entry#*=}
  env_prefix+="export $key=$(printf '%q' "$val"); "
done

# Run AppleScript to create iTerm layout
ENV_PREFIX="$env_prefix" osascript <<EOF
on run
  set workdir to "$WORKDIR"
  set envPrefix to (system attribute "ENV_PREFIX")

  tell application "iTerm"
    -- use current session and split it
    tell current session of current window
      -- split into top and bottom
      set topPane to it
      set bottomPane to (split horizontally with default profile)
    end tell

    -- split top pane into left and right
    tell topPane
      set topLeftPane to it
      set topRightPane to (split vertically with default profile)
    end tell

    -- top left pane: run codex in the repo
    tell topLeftPane
      write text "cd " & workdir & "; if command -v codex >/dev/null 2>&1; then " & envPrefix & " codex; else echo \"[warn] codex not found in PATH\"; fi"
    end tell

    -- top right pane: run claude code (dangerously skip permissions)
    tell topRightPane
      write text "cd " & workdir & "; if command -v claude >/dev/null 2>&1; then " & envPrefix & " claude code --dangerously-skip-permissions; else echo \"[warn] claude not found in PATH\"; fi"
    end tell

    -- bottom pane: leave as terminal (just cd to workdir)
    tell bottomPane
      write text "cd " & workdir
    end tell

  end tell
end run
EOF

echo "[done] iTerm layout created for: $WORKDIR"
