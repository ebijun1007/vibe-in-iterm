#!/usr/bin/env bash
set -e

# Check if running in iTerm
if [ "$TERM_PROGRAM" != "iTerm.app" ]; then
  echo "[error] This command only works in iTerm.app"
  exit 1
fi

# Get current working directory
WORKDIR="$PWD"

# Pre-flight: ensure markdown files exist (only create if missing)
created_files=()
seeded_files=()
script_dir="$(cd "$(dirname "$0")/.." && pwd)"
template_dir="$script_dir/templates"
bootstrap_files=(AGENTS.md CLAUDE.md CORE.md CUSTOM_PROMPTS.md todo.md)
OPENCODE_CONFIG="$WORKDIR/.opencode/opencode.json"
CODEX_HOME="$WORKDIR/.codex"

for file in "${bootstrap_files[@]}"; do
  if [ ! -e "$file" ]; then
    touch "$file"
    created_files+=("$file")
  fi
done

seed_if_empty() {
  local target="$1"
  local template="$2"
  if [ -s "$target" ]; then
    return
  fi

  if [ -f "$template" ] && [ -s "$template" ]; then
    cp "$template" "$target"
  else
    : > "$target"
  fi
  seeded_files+=("$target")
}

seed_if_empty "CLAUDE.md" "$template_dir/CLAUDE.md"
seed_if_empty "CORE.md" "$template_dir/CORE.md"
seed_if_empty "CUSTOM_PROMPTS.md" "$template_dir/CUSTOM_PROMPTS.md"
seed_if_empty "todo.md" "$template_dir/todo.md"
seed_if_empty "AGENTS.md" "$template_dir/AGENTS.md"

if [ ${#created_files[@]} -gt 0 ]; then
  echo "[info] Created ${created_files[*]}"
fi
if [ ${#seeded_files[@]} -gt 0 ]; then
  echo "[info] Seeded ${seeded_files[*]}"
fi
if [ ${#created_files[@]} -eq 0 ] && [ ${#seeded_files[@]} -eq 0 ]; then
  echo "[info] Markdown files already present"
fi

# Copy templates into the current directory without overwriting existing files
if [ -d "$template_dir" ]; then
  mapfile -t cloned < <(rsync -ai --ignore-existing "$template_dir"/ "$WORKDIR"/ | cut -c12-)
  if [ ${#cloned[@]} -gt 0 ]; then
    echo "[info] Cloned templates into $WORKDIR: ${cloned[*]}"
  else
    echo "[info] Templates already present; nothing to clone"
  fi
else
  echo "[warn] Template directory not found at $template_dir"
fi

# Run AppleScript to create iTerm layout
osascript <<EOF
on run
  set workdir to "$WORKDIR"
  set envExports to "export OPENCODE_CONFIG=\"$OPENCODE_CONFIG\"; export CODEX_HOME=\"$CODEX_HOME\";"

  tell application "iTerm"
    -- keep current window, just add a new tab
    set theWindow to current window
    tell theWindow
      create tab with default profile
      set theTab to current tab
    end tell

    -- first session in the new tab
    tell current session of theTab
      -- split into left and right
      set leftPane to it
      set rightPane to (split vertically with default profile)
    end tell

    -- split the right pane into 3 sections (top, middle, bottom)
    tell rightPane
      set topRight to it
      set middleBottomPane to (split horizontally with default profile)
    end tell

    tell middleBottomPane
      set middleRight to it
      set bottomRight to (split horizontally with default profile)
    end tell

    -- left pane: watch todo.md (create if not exists)
    tell leftPane
      write text "cd " & workdir & "; " & envExports & " [ ! -f todo.md ] && touch todo.md; command -v fswatch >/dev/null 2>&1 || brew install fswatch; fswatch -o todo.md | while read; do clear; cat todo.md; done"
    end tell

    -- top-right: run codex
    tell topRight
      write text "cd " & workdir & "; " & envExports & " codex"
    end tell

    -- middle-right: run claude with --dangerously-skip-permissions
    tell middleRight
      write text "cd " & workdir & "; " & envExports & " claude --dangerously-skip-permissions"
    end tell

    -- bottom-right: just cd into the repo and stay there
    tell bottomRight
      write text "cd " & workdir & "; " & envExports
    end tell
  end tell
end run
EOF

echo "[done] iTerm layout created for: $WORKDIR"
