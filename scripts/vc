#!/usr/bin/env bash
set -e

# Get current working directory
WORKDIR="$PWD"

script_dir="$(cd "$(dirname "$0")" && pwd)"
repo_url="https://github.com/ebijun1007/vibe-in-iterm.git"
template_dir="$script_dir/templates"
cleanup_dir=""
todo_path="$WORKDIR/todo.md"
data_dir="$HOME/Library/Application Support/ai/bloop/vibe-kanban"
kanban_running=0
kanban_pid=""
ollama_port=11434
ollama_busy=0

print_vibe_port() {
  local pid_list=("$@")
  if ! command -v lsof >/dev/null 2>&1; then
    return 1
  fi

  # Build PID candidates: supplied list (if any) plus all vibe-kanban matches
  local candidate_pids=()
  if [ "${#pid_list[@]}" -gt 0 ]; then
    candidate_pids+=("${pid_list[@]}")
  fi
  while read -r pid; do
    candidate_pids+=("$pid")
  done < <(pgrep -f "vibe-kanban" 2>/dev/null || true)

  # Deduplicate
  local uniq_pids=()
  local seen=""
  for pid in "${candidate_pids[@]}"; do
    [ -z "$pid" ] && continue
    if [[ ",$seen," != *",$pid,"* ]]; then
      uniq_pids+=("$pid")
      seen+="${seen:+,}$pid"
    fi
  done

  local port_line=""
  for pid in "${uniq_pids[@]}"; do
    port_line=$(lsof -Pan -p "$pid" -iTCP -sTCP:LISTEN 2>/dev/null | awk 'NR>1{print $9; exit}')
    if [ -n "$port_line" ]; then
      break
    fi
  done

  # Final fallback: scan all listening sockets and inspect process args for vibe-kanban
  if [ -z "$port_line" ]; then
    while read -r pid port_field; do
      if ps -p "$pid" -o args= 2>/dev/null | grep -qi "vibe[- ]*kanban"; then
        port_line="$port_field"
        break
      fi
    done < <(lsof -nP -iTCP -sTCP:LISTEN 2>/dev/null | awk 'NR>1{print $2 " " $9}')
  fi

  if [ -z "$port_line" ]; then
    return 1
  fi

  local port=${port_line##*:}
  port=${port%%[^0-9]*}
  if [ -z "$port" ]; then
    return 1
  fi

  local ts
  ts=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
  echo "$ts  INFO vibe-kanban: Server running on http://127.0.0.1:$port"
}

mkdir -p "$data_dir"
if [ -f "$WORKDIR/profiles.json" ]; then
  cp "$WORKDIR/profiles.json" "$data_dir/profiles.json"
  echo "[info] Copied profiles.json to $data_dir"
else
  echo "[warn] profiles.json not found in repo root; skipping copy"
fi

# Launch vibe-kanban in the background on its default port if not already running
if pgrep -f "vibe-kanban" >/dev/null 2>&1; then
  kanban_running=1
  kanban_pid=$(pgrep -f "vibe-kanban" | head -n1)
fi

if [ "$kanban_running" -eq 1 ]; then
  if ! print_vibe_port "$kanban_pid"; then
    echo "[info] vibe-kanban already running; leaving it as-is"
  fi
elif command -v npx >/dev/null 2>&1; then
  (cd "$WORKDIR" && npx vibe-kanban >/dev/null 2>&1 &)
  kanban_pid=$!
  sleep 1
  if ! print_vibe_port "$kanban_pid"; then
    echo "[info] Started vibe-kanban in background (pid $kanban_pid)"
  else
    :
  fi
else
  echo "[warn] npx not found; cannot start vibe-kanban"
fi

# Launch ollama serve in the background when port 11434 is free
if command -v lsof >/dev/null 2>&1; then
  if lsof -iTCP:"$ollama_port" -sTCP:LISTEN >/dev/null 2>&1; then
    ollama_busy=1
  fi
elif command -v nc >/dev/null 2>&1; then
  if nc -z localhost "$ollama_port" >/dev/null 2>&1; then
    ollama_busy=1
  fi
else
  echo "[warn] Unable to check port $ollama_port availability (lsof/nc missing); attempting launch"
fi

if command -v ollama >/dev/null 2>&1; then
  if [ "$ollama_busy" -eq 1 ]; then
    echo "[info] Port $ollama_port already in use; skipping ollama serve launch"
  else
    (OLLAMA_HOST="${OLLAMA_HOST:-}" ollama serve >/dev/null 2>&1 &)
    echo "[info] Started ollama serve in background on port $ollama_port"
  fi
else
  echo "[warn] ollama not found; cannot start ollama serve"
fi

if [ ! -d "$template_dir" ]; then
  if command -v git >/dev/null 2>&1; then
    cleanup_dir="$(mktemp -d)"
    git clone -q --depth 1 "$repo_url" "$cleanup_dir/repo"
    template_dir="$cleanup_dir/repo/templates"
  else
    echo "[warn] git not found and templates directory missing; skipping template copy"
    template_dir=""
  fi
fi

# Copy templates into the current directory without overwriting existing files
if [ -n "$template_dir" ] && [ -d "$template_dir" ]; then
  mapfile -t cloned < <(rsync -ai --ignore-existing "$template_dir"/ "$WORKDIR"/ | cut -c12-)
  if [ ${#cloned[@]} -gt 0 ]; then
    echo "[info] Cloned templates into $WORKDIR: ${cloned[*]}"
  else
    echo "[info] Templates already present; nothing to clone"
  fi
else
  echo "[warn] Template directory not found; skipping template copy"
fi

[ -n "$cleanup_dir" ] && rm -rf "$cleanup_dir"

# Ensure .gitignore has expected entries
ignore_entries=(.claude .opencode .codex .design refactor.json issues.md todo.md)
gitignore_path="$WORKDIR/.gitignore"
[[ -f "$gitignore_path" ]] || touch "$gitignore_path"
added_entries=()
for entry in "${ignore_entries[@]}"; do
  if ! grep -qxF "$entry" "$gitignore_path"; then
    echo "$entry" >> "$gitignore_path"
    added_entries+=("$entry")
  fi
done
if [ ${#added_entries[@]} -gt 0 ]; then
  echo "[info] Updated .gitignore with: ${added_entries[*]}"
fi

# Open todo.md in VS Code for the current directory
if command -v code >/dev/null 2>&1; then
  [ -f "$todo_path" ] || touch "$todo_path"
  code "$todo_path"
else
  echo "[warn] code command not found; skipping opening todo.md"
fi

echo "[done] Workspace prepared for: $WORKDIR"
