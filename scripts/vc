#!/usr/bin/env bash
set -e

# Check if running in iTerm
if [ "$TERM_PROGRAM" != "iTerm.app" ]; then
  echo "[error] This command only works in iTerm.app"
  exit 1
fi

# Get current working directory
WORKDIR="$PWD"

script_dir="$(cd "$(dirname "$0")" && pwd)"
OPENCODE_CONFIG="$WORKDIR/.opencode/opencode.json"
CODEX_HOME="$WORKDIR/.codex"
repo_url="https://github.com/ebijun1007/vibe-in-iterm.git"
template_dir="$script_dir/templates"
cleanup_dir=""
env_exports=()
default_nnn_opener_script="$CODEX_HOME/nnn_opener.sh"
todo_path="$WORKDIR/todo.md"
kanban_port=8888
kanban_busy=0

# Launch vibe-kanban in the background when port 8888 is free
if command -v lsof >/dev/null 2>&1; then
  if lsof -iTCP:"$kanban_port" -sTCP:LISTEN >/dev/null 2>&1; then
    kanban_busy=1
  fi
elif command -v nc >/dev/null 2>&1; then
  if nc -z localhost "$kanban_port" >/dev/null 2>&1; then
    kanban_busy=1
  fi
else
  echo "[warn] Unable to check port $kanban_port availability (lsof/nc missing); attempting launch"
fi

if [ "$kanban_busy" -eq 1 ]; then
  echo "[info] Port $kanban_port already in use; skipping vibe-kanban launch"
elif command -v npx >/dev/null 2>&1; then
  (cd "$WORKDIR" && PORT="$kanban_port" npx vibe-kanban >/dev/null 2>&1 &)
  echo "[info] Started vibe-kanban on port $kanban_port in background"
else
  echo "[warn] npx not found; cannot start vibe-kanban"
fi

if [ ! -d "$template_dir" ]; then
  if command -v git >/dev/null 2>&1; then
    cleanup_dir="$(mktemp -d)"
    git clone -q --depth 1 "$repo_url" "$cleanup_dir/repo"
    template_dir="$cleanup_dir/repo/templates"
  else
    echo "[warn] git not found and templates directory missing; skipping template copy"
    template_dir=""
  fi
fi

# Copy templates into the current directory without overwriting existing files
if [ -n "$template_dir" ] && [ -d "$template_dir" ]; then
  mapfile -t cloned < <(rsync -ai --ignore-existing "$template_dir"/ "$WORKDIR"/ | cut -c12-)
  if [ ${#cloned[@]} -gt 0 ]; then
    echo "[info] Cloned templates into $WORKDIR: ${cloned[*]}"
  else
    echo "[info] Templates already present; nothing to clone"
  fi
else
  echo "[warn] Template directory not found; skipping template copy"
fi

[ -n "$cleanup_dir" ] && rm -rf "$cleanup_dir"

# Ensure .gitignore has expected entries
ignore_entries=(.claude .opencode .codex .design refactor.json issues.md todo.md)
gitignore_path="$WORKDIR/.gitignore"
[[ -f "$gitignore_path" ]] || touch "$gitignore_path"
added_entries=()
for entry in "${ignore_entries[@]}"; do
  if ! grep -qxF "$entry" "$gitignore_path"; then
    echo "$entry" >> "$gitignore_path"
    added_entries+=("$entry")
  fi
done
if [ ${#added_entries[@]} -gt 0 ]; then
  echo "[info] Updated .gitignore with: ${added_entries[*]}"
fi

# Open todo.md in VS Code for the current directory
if command -v code >/dev/null 2>&1; then
  [ -f "$todo_path" ] || touch "$todo_path"
  code "$todo_path"
else
  echo "[warn] code command not found; skipping opening todo.md"
fi

# Build shared environment exports for the iTerm panes
env_exports+=("OPENCODE_CONFIG=$OPENCODE_CONFIG")
env_exports+=("CODEX_HOME=$CODEX_HOME")

nnn_opener="${VC_NNN_OPENER:-${NNN_OPENER:-}}"
nnn_opener_source=""
nnn_opts="${NNN_OPTS:-}"
if [ -n "$nnn_opener" ]; then
  nnn_opener_source="ENV"
elif command -v bat >/dev/null 2>&1; then
  mkdir -p "$CODEX_HOME"
  cat > "$default_nnn_opener_script" <<'EOF'
#!/usr/bin/env bash
set -e

target="$1"
if [ -z "$target" ]; then
  exit 0
fi

if command -v bat >/dev/null 2>&1; then
  bat --style=numbers --color=always --paging=always --pager="less -R" "$target"
else
  "${EDITOR:-vi}" "$target"
fi
EOF
  chmod +x "$default_nnn_opener_script"
  nnn_opener="$default_nnn_opener_script"
  nnn_opener_source="bat-wrapper"
fi

if [ -n "$nnn_opener" ]; then
  env_exports+=("NNN_OPENER=$nnn_opener")
  if [ "$nnn_opener_source" = "ENV" ]; then
    echo "[info] NNN_OPENER propagated from environment: $nnn_opener"
  else
    echo "[info] NNN_OPENER set for nnn to use bat: $nnn_opener"
  fi
fi
if [ -z "$nnn_opts" ]; then
  env_exports+=("NNN_OPTS=c")
  echo "[info] NNN_OPTS defaulted to 'c' for CLI opener"
else
  env_exports+=("NNN_OPTS=$nnn_opts")
fi

env_prefix=""
for entry in "${env_exports[@]}"; do
  key=${entry%%=*}
  val=${entry#*=}
  env_prefix+="export $key=$(printf '%q' "$val"); "
done

# Run AppleScript to create iTerm layout
ENV_PREFIX="$env_prefix" osascript <<EOF
on run
  set workdir to "$WORKDIR"
  set envPrefix to (system attribute "ENV_PREFIX")

  tell application "iTerm"
    -- keep current window, just add a new tab
    set theWindow to current window
    tell theWindow
      create tab with default profile
      set theTab to current tab
    end tell

    -- first session in the new tab
    tell current session of theTab
      -- split into left and right
      set leftPane to it
      set rightPane to (split vertically with default profile)
    end tell

    -- left pane: run codex in the repo
    tell leftPane
      write text "cd " & workdir & "; if command -v codex >/dev/null 2>&1; then " & envPrefix & " codex; else echo \"[warn] codex not found in PATH\"; fi"
    end tell

    -- right pane: run claude code (dangerously skip permissions)
    tell rightPane
      write text "cd " & workdir & "; if command -v claude >/dev/null 2>&1; then " & envPrefix & " claude code --dangerously-skip-permissions; else echo \"[warn] claude not found in PATH\"; fi"
    end tell

  end tell
end run
EOF

echo "[done] iTerm layout created for: $WORKDIR"
