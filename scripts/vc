#!/usr/bin/env bash
set -e

# Get current working directory
WORKDIR="$PWD"

script_dir="$(cd "$(dirname "$0")" && pwd)"
repo_url="https://github.com/ebijun1007/vibe-in-iterm.git"
template_dir="$script_dir/templates"
cleanup_dir=""
todo_path="$WORKDIR/todo.md"
data_dir="$HOME/Library/Application Support/ai/bloop/vibe-kanban"
ollama_port=11434
ollama_busy=0

mkdir -p "$data_dir"
if [ -f "$WORKDIR/profiles.json" ]; then
  cp "$WORKDIR/profiles.json" "$data_dir/profiles.json"
  echo "[info] Copied profiles.json to $data_dir"
else
  echo "[warn] profiles.json not found in repo root; skipping copy"
fi

# Launch vibe-kanban in the background on its default port (multiple processes allowed)
# Launch ollama serve in the background when port 11434 is free
if command -v lsof >/dev/null 2>&1; then
  if lsof -iTCP:"$ollama_port" -sTCP:LISTEN >/dev/null 2>&1; then
    ollama_busy=1
  fi
elif command -v nc >/dev/null 2>&1; then
  if nc -z localhost "$ollama_port" >/dev/null 2>&1; then
    ollama_busy=1
  fi
else
  echo "[warn] Unable to check port $ollama_port availability (lsof/nc missing); attempting launch"
fi

if command -v ollama >/dev/null 2>&1; then
  if [ "$ollama_busy" -eq 1 ]; then
    echo "[info] Port $ollama_port already in use; skipping ollama serve launch"
  else
    (OLLAMA_HOST="${OLLAMA_HOST:-}" ollama serve >/dev/null 2>&1 &)
    echo "[info] Started ollama serve in background on port $ollama_port"
  fi
else
  echo "[warn] ollama not found; cannot start ollama serve"
fi

if [ ! -d "$template_dir" ]; then
  if command -v git >/dev/null 2>&1; then
    cleanup_dir="$(mktemp -d)"
    git clone -q --depth 1 "$repo_url" "$cleanup_dir/repo"
    template_dir="$cleanup_dir/repo/templates"
  else
    echo "[warn] git not found and templates directory missing; skipping template copy"
    template_dir=""
  fi
fi

# Copy templates into the current directory without overwriting existing files
if [ -n "$template_dir" ] && [ -d "$template_dir" ]; then
  mapfile -t cloned < <(rsync -ai --ignore-existing "$template_dir"/ "$WORKDIR"/ | cut -c12-)
  if [ ${#cloned[@]} -gt 0 ]; then
    echo "[info] Cloned templates into $WORKDIR: ${cloned[*]}"
  else
    echo "[info] Templates already present; nothing to clone"
  fi
else
  echo "[warn] Template directory not found; skipping template copy"
fi

[ -n "$cleanup_dir" ] && rm -rf "$cleanup_dir"

# Ensure .gitignore has expected entries
ignore_entries=(.claude .opencode .codex .design refactor.json issues.md todo.md)
gitignore_path="$WORKDIR/.gitignore"
[[ -f "$gitignore_path" ]] || touch "$gitignore_path"
added_entries=()
for entry in "${ignore_entries[@]}"; do
  if ! grep -qxF "$entry" "$gitignore_path"; then
    echo "$entry" >> "$gitignore_path"
    added_entries+=("$entry")
  fi
done
if [ ${#added_entries[@]} -gt 0 ]; then
  echo "[info] Updated .gitignore with: ${added_entries[*]}"
fi

# Seed opencode.json if missing
opencode_path="$WORKDIR/opencode.json"
if [ ! -f "$opencode_path" ]; then
  cat > "$opencode_path" <<'EOF'
{
  "$schema": "https://opencode.ai/config.json",
  "provider": {
    "ollama": {
      "npm": "@ai-sdk/openai-compatible",
      "name": "Ollama (local)",
      "options": {
        "baseURL": "http://localhost:11434/v1"
      },
      "models": {
        "hhao/qwen2.5-coder-tools:14b": {
          "name": "Qwen2.5 Coder Tools 14B (local)"
        }
      }
    }
  },
  "model": "ollama/hhao/qwen2.5-coder-tools:14b",
  "agent": {
    "build": {
      "description": "Default coding mode with only OpenCode tools.",
      "tools": {
        "read": true,
        "write": true,
        "edit": true,
        "bash": true,
        "grep": true,
        "glob": true,
        "list": true,
        "webfetch": true,
        "patch": true,
        "todoread": true,
        "todowrite": true
      },
      "prompt": "{file:./.claude/CLAUDE.md}"
    }
  },
  "instructions": [
    ".claude/CLAUDE.md",
    ".design/architecture.md",
    ".design/guidelines.md",
    ".design/decisions.md"
  ]
}
EOF
  echo "[info] Wrote opencode.json to $opencode_path"
else
  echo "[info] opencode.json already exists; leaving as-is"
fi

# Open todo.md in VS Code for the current directory
if command -v code >/dev/null 2>&1; then
  [ -f "$todo_path" ] || touch "$todo_path"
  code "$todo_path"
else
  echo "[warn] code command not found; skipping opening todo.md"
fi

echo "[done] Workspace prepared for: $WORKDIR"

# Launch vibe-kanban in the foreground at the end (vibe-kanban will pick an available port)
if command -v npx >/dev/null 2>&1; then
  echo "[info] Starting vibe-kanban in foreground (Ctrl+C to stop; logs below)"
  (cd "$WORKDIR" && npx vibe-kanban)
else
  echo "[warn] npx not found; cannot start vibe-kanban"
fi
