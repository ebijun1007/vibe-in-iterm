#!/usr/bin/env bash
set -e

# Check if running in iTerm
if [ "$TERM_PROGRAM" != "iTerm.app" ]; then
  echo "[error] This command only works in iTerm.app"
  exit 1
fi

# Get current working directory
WORKDIR="$PWD"

script_dir="$(cd "$(dirname "$0")" && pwd)"
repo_url="https://github.com/ebijun1007/vibe-in-iterm.git"
template_dir="$script_dir/templates"
cleanup_dir=""
todo_path="$WORKDIR/todo.md"
data_dir="$HOME/Library/Application Support/ai.bloop.vibe-kanban"
CODEX_HOME="$WORKDIR/.codex"
env_exports=()

if [ ! -d "$template_dir" ]; then
  if command -v git >/dev/null 2>&1; then
    cleanup_dir="$(mktemp -d)"
    git clone -q --depth 1 "$repo_url" "$cleanup_dir/repo"
    template_dir="$cleanup_dir/repo/templates"
  else
    echo "[warn] git not found and templates directory missing; skipping template copy"
    template_dir=""
  fi
fi

# Copy templates into the current directory without overwriting existing files
if [ -n "$template_dir" ] && [ -d "$template_dir" ]; then
  mapfile -t cloned < <(rsync -ai --ignore-existing "$template_dir"/ "$WORKDIR"/ | cut -c12-)
  if [ ${#cloned[@]} -gt 0 ]; then
    echo "[info] Cloned templates into $WORKDIR: ${cloned[*]}"
  else
    echo "[info] Templates already present; nothing to clone"
  fi
else
  echo "[warn] Template directory not found; skipping template copy"
fi

[ -n "$cleanup_dir" ] && rm -rf "$cleanup_dir"

# Ensure .gitignore has expected entries
ignore_entries=(.claude .codex .design refactor.json issues.md todo.md)
gitignore_path="$WORKDIR/.gitignore"
[[ -f "$gitignore_path" ]] || touch "$gitignore_path"
added_entries=()
for entry in "${ignore_entries[@]}"; do
  if ! grep -qxF "$entry" "$gitignore_path"; then
    echo "$entry" >> "$gitignore_path"
    added_entries+=("$entry")
  fi
done
if [ ${#added_entries[@]} -gt 0 ]; then
  echo "[info] Updated .gitignore with: ${added_entries[*]}"
fi

# Open todo.md in VS Code for the current directory
if command -v code >/dev/null 2>&1; then
  [ -f "$todo_path" ] || touch "$todo_path"
  code "$todo_path"
else
  echo "[warn] code command not found; skipping opening todo.md"
fi

echo "[done] Workspace prepared for: $WORKDIR"

# Check if vibe-kanban is running
if command -v npx >/dev/null 2>&1; then
  if pgrep -f "vibe-kanban" > /dev/null 2>&1; then
    pid=$(pgrep -f "vibe-kanban")
    echo "[info] vibe-kanban already running (pid $pid)"
  else
    echo "[info] vibe-kanban not running. Start it manually with: cd $WORKDIR && PORT=3000 npx vibe-kanban"
  fi
else
  echo "[warn] npx not found; cannot check vibe-kanban status"
fi

# Build shared environment exports for the iTerm panes
env_exports+=("CODEX_HOME=$CODEX_HOME")

env_prefix=""
for entry in "${env_exports[@]}"; do
  key=${entry%%=*}
  val=${entry#*=}
  env_prefix+="export $key=$(printf '%q' "$val"); "
done

# Run AppleScript to create iTerm layout
ENV_PREFIX="$env_prefix" osascript <<EOF
on run
  set workdir to "$WORKDIR"
  set envPrefix to (system attribute "ENV_PREFIX")

  tell application "iTerm"
    -- keep current window, just add a new tab
    set theWindow to current window
    tell theWindow
      create tab with default profile
      set theTab to current tab
    end tell

    -- first session in the new tab
    tell current session of theTab
      -- split into top and bottom
      set topPane to it
      set bottomPane to (split horizontally with default profile)
    end tell

    -- split top pane into left and right
    tell topPane
      set topLeftPane to it
      set topRightPane to (split vertically with default profile)
    end tell

    -- top left pane: run codex in the repo
    tell topLeftPane
      write text "cd " & workdir & "; if command -v codex >/dev/null 2>&1; then " & envPrefix & " codex; else echo \"[warn] codex not found in PATH\"; fi"
    end tell

    -- top right pane: run claude code (dangerously skip permissions)
    tell topRightPane
      write text "cd " & workdir & "; if command -v claude >/dev/null 2>&1; then " & envPrefix & " claude code --dangerously-skip-permissions; else echo \"[warn] claude not found in PATH\"; fi"
    end tell

    -- bottom pane: leave as terminal (just cd to workdir)
    tell bottomPane
      write text "cd " & workdir
    end tell

  end tell
end run
EOF

echo "[done] iTerm layout created for: $WORKDIR"
