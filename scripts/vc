#!/usr/bin/env bash
set -e

# Check if running in iTerm
if [ "$TERM_PROGRAM" != "iTerm.app" ]; then
  echo "[error] This command only works in iTerm.app"
  exit 1
fi

# Get current working directory
WORKDIR="$PWD"

# Pre-flight: ensure markdown files exist (only create if missing)
created_files=()
for file in AGENTS.md CLAUDE.md todo.md; do
  if [ ! -e "$file" ]; then
    touch "$file"
    created_files+=("$file")
  fi
done

if [ ${#created_files[@]} -gt 0 ]; then
  echo "[info] Created ${created_files[*]}"
else
  echo "[info] Markdown files already present"
fi

# Run AppleScript to create iTerm layout
osascript <<EOF
on run
  set workdir to "$WORKDIR"

  tell application "iTerm"
    -- keep current window, just add a new tab
    set theWindow to current window
    tell theWindow
      create tab with default profile
      set theTab to current tab
    end tell

    -- first session in the new tab
    tell current session of theTab
      -- split into left and right
      set leftPane to it
      set rightPane to (split vertically with default profile)
    end tell

    -- split the right pane into 3 sections (top, middle, bottom)
    tell rightPane
      set topRight to it
      set middleBottomPane to (split horizontally with default profile)
    end tell

    tell middleBottomPane
      set middleRight to it
      set bottomRight to (split horizontally with default profile)
    end tell

    -- left pane: watch todo.md (create if not exists)
    tell leftPane
      write text "cd " & workdir & "; [ ! -f todo.md ] && touch todo.md; while true; do clear; cat todo.md; sleep 1; done"
    end tell

    -- top-right: run codex
    tell topRight
      write text "cd " & workdir & "; codex"
    end tell

    -- middle-right: run claude with --dangerously-skip-permissions
    tell middleRight
      write text "cd " & workdir & "; claude --dangerously-skip-permissions"
    end tell

    -- bottom-right: just cd into the repo and stay there
    tell bottomRight
      write text "cd " & workdir
    end tell
  end tell
end run
EOF

echo "[done] iTerm layout created for: $WORKDIR"
