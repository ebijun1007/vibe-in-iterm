---
name: Tasks Refresh
description: 全タスクの現状を棚卸しし、ドキュメントを同期しつつ残タスクの優先度・粒度を再整理する
author: codex
---

## Goal

`.design/tasks/` 内の全タスクを棚卸しし、`.design/` ドキュメントとの整合性を確保しつつ、残タスクの優先度・粒度を再整理する。

## Important override for this run

AGENTS.md の編集制限を、以下の範囲で解除する：
- `.design/todo.md`（ステータス同期）
- `.design/non-blocking-issues.md`（解決済みマーク追記）
- `.design/tasks/` 内の既存タスクファイル（ステータス修正・備考追記）
- `.design/tasks/` への新規タスクファイル作成（**Phase 2 でユーザー承認後のみ**）

## Process

このプロンプトは **Phase 1（調査・提案）** と **Phase 2（反映）** の2段階で進行する。Phase 1 はファイル変更を行わない。

---

### Phase 1: 調査・提案（読み取り専用）

#### 1-1. タスク一覧の走査と分類

1. `.design/tasks/` 内の `YYYYMMDD-*.md` ファイル（`README.md` を除く）を全件読み込む
2. 各タスクの `## ステータス` セクションを確認し、以下の基準で分類する：
   - `[x] 完了` → **完了**
   - `[x] 進行中` → **進行中**
   - `[x] 未着手`（または全て未チェック） → **未着手**
3. ステータスが不明確な場合（チェックボックスの書式不正等）はフラグを立てる

#### 1-2. 実装状況との照合

1. `git log --oneline -50` で直近のコミット履歴を取得する
2. 完了タスクについて、関連する実装が実際にコミット済みかを**補助的に**確認する
   - git log は参考情報。最終判定はタスクの完了条件チェックボックスと実際のコード差分で行う
3. 進行中タスクについて、未コミットの変更（`git status` / `git diff`）との関連を確認する

#### 1-3. ドキュメントとの整合性チェック

1. `.design/todo.md` を読み、タスクファイルの実態との差分を洗い出す：
   - todo.md に記載があるがタスクファイルがない項目
   - タスクファイルがあるが todo.md に未記載の項目
   - todo.md のステータスとタスクファイルのステータスが不一致の項目
2. `.design/non-blocking-issues.md` を読み、タスク完了によって解決済みになった項目を特定する：
   - 解決済み判定基準：該当タスクが完了 **かつ** 問題箇所のコードが実際に変更済み

#### 1-4. 残タスクの分析

未着手タスクについて以下を分析する：

- **粒度**: 完了条件が4つ以上かつ横断的 → 分割を検討。完了条件が1つで独立性が低い → 統合を検討
- **依存関係**: 他タスクの完了が前提となるものを特定
- **優先度提案**: 以下の基準で3段階に分類
  - **高**: ブロッカーになっている / ユーザー体験に直結 / セキュリティ関連
  - **中**: 開発効率改善 / コード品質向上
  - **低**: nice-to-have / 将来対応可

#### 1-5. 棚卸しレポートの出力

以下の形式でユーザーに提示する：

```
## 棚卸し結果

### ステータス別サマリー
- 完了: N件
- 進行中: N件
- 未着手: N件
- ステータス不明: N件（あれば）

### ドキュメント同期が必要な項目
- todo.md: [変更内容の一覧]
- non-blocking-issues.md: [解決済みにする項目]

### 残タスクの再整理提案
- 分割提案: [大きすぎるタスクの分割案]
- 統合提案: [小さすぎるタスクの統合案]
- 依存関係: [順序制約の整理]
- 優先度: [高/中/低の分類]
```

**Phase 1 完了時点で一旦停止し、ユーザーの承認を待つ。**

---

### Phase 2: 反映（ユーザー承認後）

ユーザーが承認した項目のみを反映する。承認されなかった提案は無視する。

#### 2-1. ドキュメント更新

- `.design/todo.md`: 完了済みタスクを「完了済み」セクションに移動、未完了を整理
- `.design/non-blocking-issues.md`: 解決済み項目に取り消し線（`~~テキスト~~`）と解決日を追記

#### 2-2. タスクファイルの更新

- ステータス不正の修正（実態に合わせる）
- 備考セクションへの補足追記（依存関係の明記等）

#### 2-3. タスクの分割・統合（承認された場合のみ）

- **分割**: 元タスクの備考に「分割先: YYYYMMDD-xxx.md」を記載し、新規ファイルを作成
- **統合**: 統合先タスクに完了条件を移し、統合元は備考に「統合先: YYYYMMDD-xxx.md」を記載してステータスを完了にする
- **新規タスクファイルの作成はユーザーの明示的な承認なしに行わない**

#### 2-4. 変更サマリーの報告

実施した変更の一覧を報告する。

## Guardrails

- Phase 1 ではファイルを一切変更しない（読み取り・分析・提案のみ）
- Phase 2 ではユーザーが承認した項目のみ反映する
- 新規タスクファイルの作成は必ずユーザーの承認を得る
- タスクのステータス判定は `## ステータス` セクション内のチェックボックスを唯一の情報源とする
- git log は補助的な証跡として使い、最終判定はタスク記述とコード差分で行う
- 優先度・依存関係の変更は提案のみ行い、反映はユーザー承認後
