---
name: Debt Sweep
description: 技術負債をテックリード・SRE・セキュリティの観点で洗い出し、リファクタ系タスクとして起票する
author: codex
---

## Goal

プロジェクトの設計ドキュメントと実装コードを突合し、テックリード・SRE・セキュリティの3観点から技術負債や乖離を発見してタスクとして起票する。

起票されたタスクは即時修正を目的とせず、着手時にユーザーと議論しながら必要に応じて解消するためのバックログとなる。

一人でフルスタックに開発・運用するリポジトリを想定している。

## Important override for this run

AGENTS.md の編集制限を、以下の範囲で解除する：
- `.design/tasks/` への新規タスクファイル作成
- `.design/non-blocking-issues.md`（新規発見の追記、既存項目の昇格・削除）

コードの変更は行わない（読み取り・分析のみ）。

## Process

### 1. プロジェクト構造の把握

1. リポジトリのディレクトリ構成を確認し、技術スタック・フレームワーク・主要な構成要素を把握する
2. `.design/` 配下に設計ドキュメントがあれば読み込み、設計方針・制約・決定事項を把握する
   - アーキテクチャ設計（構造、レイヤー、データモデル）
   - 開発ガイドライン（命名、モジュール境界、テスト方針）
   - 意思決定記録（ADR）
   - 既知の課題一覧（重複起票を避ける）
3. 設計ドキュメントがない場合は、コードから設計意図を読み取って進める

### 2. 実装コードの走査

コードベースを以下の観点で読み進める（プロジェクトに該当する部分のみ）：

1. **データ層**: DB スキーマ / マイグレーション / ORM 定義 / クエリ
2. **アーキテクチャ境界**: ルーティング → ビジネスロジック → データアクセスのレイヤー依存
3. **バックグラウンド処理**: Cron / Queue / Worker / バッチ処理
4. **認証・認可**: ログインフロー、セッション管理、トークン処理、権限チェック
5. **外部連携**: 外部 API クライアント、Webhook、ファイルストレージ
6. **インフラ設定**: 設定ファイル、環境変数、デプロイ設定

### 3. 3観点でのレビュー

#### テックリード観点
- 設計ドキュメントと実装の乖離（ドキュメントにあるが未実装、実装があるが未記載）
- レイヤー違反（プレゼンテーション層から DB を直接呼ぶ等）
- モジュール境界の崩れ（循環依存、不適切な結合）
- ハンドラ / コントローラの肥大化（ビジネスロジックの混入）
- 命名規則の不統一
- dead code、不要な re-export、未使用の依存

#### SRE 観点
- エラーハンドリングの欠如（外部呼び出し、DB クエリ、ファイル操作）
- リトライ・タイムアウト・サーキットブレーカーの不備
- バックグラウンドジョブの冪等性
- ログ・モニタリング・アラートの不足
- ストレージのリソース管理（孤児データ、肥大化リスク）
- マイグレーション・デプロイの安全性（ロールバック可能性）

#### セキュリティ観点
- 認証・認可の不備（トークン検証、セッション固定、権限昇格）
- インジェクション（SQL、XSS、CSRF、コマンド）
- シークレット管理（ハードコード、ログ出力、.env のコミット）
- 入力バリデーションの漏れ（ユーザー入力、外部 API レスポンス）
- ファイルアクセス制御（署名 URL、パストラバーサル、アップロード検証）

### 4. 既知の課題一覧（non-blocking-issues）のトリアージ

既知の課題一覧がある場合、各項目を実装状況と照合して以下に振り分ける：

- **タスクへ昇格**: 対応すべきと判断した項目 → `.design/tasks/` にタスク起票し、課題一覧から削除する
- **対応不要として削除**: 実装変更により解消済み、または前提が変わり不要になった項目 → 課題一覧から削除する
- **据え置き**: 現時点で判断が変わらない項目 → そのまま残す

### 5. 新規発見事項の分類

各発見を以下の重要度で分類する：

- **高**: セキュリティリスク / データ損失リスク / 本番障害リスク
- **中**: 設計乖離 / 保守性低下 / スケーラビリティ懸念
- **低**: コード品質 / 命名 / ドキュメント同期

### 6. タスクの起票

発見事項ごとに `.design/tasks/YYYYMMDD-title.md` を作成する。タスクテンプレート（`.design/tasks/README.md`）がある場合はそれに準拠し、以下の情報を含める：

```markdown
# [発見事項のタイトル]

## ステータス
- [x] 未着手 / [ ] 進行中 / [ ] 完了

## 概要
[何が問題か、なぜ技術負債なのか]

## 観点
[テックリード / SRE / セキュリティ]

## 重要度
[高 / 中 / 低]

## 完了条件
- [ ] 条件1
- [ ] 条件2

## 備考
- 発見元: audit (YYYY-MM-DD)
- 関連ファイル: [対象ファイルパス]
```

関連性の高い小さな発見は1つのタスクにまとめてよい。

### 7. .design/ 配下の変更をコミット

`.design/` 配下に差分がある場合、まとめてコミットする：

```bash
git add .design/ && \
git commit -m "$(cat <<'EOF'
chore: audit technical debt and create refactor tasks

Co-Authored-By: Claude <noreply@anthropic.com>
EOF
)"
```

push はしない。

### 8. 監査レポートの出力

以下を報告する：

```
## 監査結果

### サマリー
- 発見数: N件（高: X / 中: Y / 低: Z）
- 起票タスク数: N件

### 既知課題のトリアージ
- タスクへ昇格: [一覧]
- 対応不要として削除: [一覧]
- 据え置き: [一覧]

### 観点別の新規発見
- テックリード: [一覧]
- SRE: [一覧]
- セキュリティ: [一覧]

### 特に優先すべき項目
[高重要度の項目を簡潔に説明]
```

## Guardrails

- コードの変更は一切行わない（読み取り・分析・タスク起票のみ）
- 既知の課題から昇格した項目以外で、既存タスクと重複する項目は起票しない
- 起票するタスクは「着手時に議論して判断する」前提のバックログであり、即時修正を強制しない
- 過度に細かい指摘（typo、フォーマット等）はタスク化せず無視する
- 推測や仮定に基づく指摘はしない。コードで確認できた事実のみを報告する
