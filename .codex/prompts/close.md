---
name: Close Task
description: 着手中タスクのセルフレビュー・コミット・masterマージまたはPR作成・完了処理を一括で行うプロンプト
author: codex
---

## Goal

現在着手中（進行中）のタスクに対して、セルフレビュー → コミット（タスク更新含む） → ルールに応じて master マージまたは PR 作成 → 必要に応じた後続タスク起票を一連で行う。

## Important override for this run

AGENTS.md の編集制限を、このタスク完了処理に必要な範囲で解除する：
- `.design/tasks/` 内のタスクファイル（ステータス更新）
- `.design/non-blocking-issues.md`（DEFERRED項目の追記）
- `.design/tasks/` への新規タスクファイル作成（ユーザー承認後のみ）

## Process

### 1. 着手中タスクの特定

1. **会話ログを確認**し、この会話セッション中に pick プロンプト等で着手したタスク、またはユーザーが言及・作業していたタスクを特定する
2. 会話ログから特定できない場合は、ユーザーにどのタスクを完了させるか確認する
3. 対象タスクの `.design/tasks/YYYYMMDD-*.md` ファイルを読み込み、完了条件を把握する

### 2. 対象ファイルの特定

1. **会話ログから、自分がこのセッション中に作成・編集したファイルの一覧を確認する**
2. そのファイル一覧のみを対象とする。他の並行作業による差分は**無視する**
3. `git diff` は対象ファイルに絞って確認する（例: `git diff -- <file1> <file2> ...`）
4. 対象外のファイルについて確認や言及をしない。止まらずに進める

### 3. セルフレビュー

変更差分を以下の観点でレビュー：
- **優先順位**: 正しさ > 安全性 > 変更容易性 > 運用性 > 性能 > 好み
- **設計ドキュメント整合**: `.design/architecture.md` と `.design/guidelines.md` に矛盾しない
- **設計原則**:
  - シンプルに保つ（複雑さは最大の敵）
  - 高凝集・低結合（変更理由ごとにまとまり、他への波及を最小化）
  - 境界を明確化（責務・データ所有者・API）
  - データ整合性最優先（正しさ > 速さ、トランザクション・不変条件）
  - ボトルネック計測後に最適化（推測で分割しない）
  - 可用性より運用可能性（観測・デプロイ・ロールバック・移行容易性）
  - 並行開発可能な形（機能フラグ、小さな変更、独立デプロイ単位）
  - 分散は最後（まずモノリスで伸ばし、必要時に分割）
  - 作り込みすぎない（抽象化は必要になってから）
- **変更加筆ルール**:
  - 1PR = 1意図（機能追加とリファクタを混在させない）
  - 指摘は `Must / Suggest / Question` で分類する
  - 指摘には具体的な代案を添える
- **チェック観点**:
  - 正しさ: 仕様整合、境界条件（空/nil/0/最大値/重複/並行実行）、失敗時の扱い（例外/リトライ/部分成功）
  - セキュリティ: 認可、入力検証・サニタイズ、機密情報露出防止、外部連携の署名検証/タイムアウト/リトライ/レート制限
  - 設計: 責務肥大化の回避、高凝集・低結合、境界明確化、命名の明確性
  - 性能: N+1/不要な全件取得/重いループ/無駄な外部API、インデックス前提、計測に基づく最適化
  - 監査・運用: 監査証跡（誰が/いつ/何を）、障害切り分け可能なログ、移行と後方互換とロールバック

分類：
- **BLOCKING**: コミット前に修正必須 → コミットせず問題を報告して終了
- **QUICK-FIX**: 小規模・局所的 → この場で修正してコミット
- **DEFERRED**: 大規模・横断的 → `.design/non-blocking-issues.md` に記録
- 指摘ごとに `Must / Suggest / Question` のラベルを併記する

### 4. コミット（タスク更新を含む）

1. QUICK-FIX があれば先に修正を適用
2. タスクファイルのステータスを更新：`[x] 進行中` → `[ ] 進行中`、`[ ] 完了` → `[x] 完了`
3. 達成済みの完了条件にチェックを入れる
4. タスク関連ファイル＋タスクファイル自体をまとめてステージ（`git add .` 禁止）
5. HEREDOC形式で **単一コミット** として実行：

```bash
git add <files...> <task-file> && \
git commit -m "$(cat <<'EOF'
短い要約

- 詳細1
- 詳細2

Co-Authored-By: Claude <noreply@anthropic.com>
EOF
)"
```

6. この時点ではまだ push/PR/merge は行わない（次ステップで分岐処理）

### 5. masterマージ or PR作成（分岐）

まず以下の判定を行う：

1. `git remote get-url origin` を実行し、`origin` のURLを取得する
   - 例: `origin_url=$(git remote get-url origin)`
   - 例: `owner=$(echo "$origin_url" | sed -E 's#(git@github\\.com:|https://github\\.com/)##; s#/.*##')`
2. `origin` が未設定（コマンド失敗）の場合は **PR不要**
3. `origin` が設定済みで、URLのオーナーが `ebijun1007` の場合は **PR不要**
4. 上記以外（`origin` オーナーが `ebijun1007` 以外）は **PR必須**

### 5-A. PR不要（origin未設定 or owner=ebijun1007）の場合

1. `master` に切り替える：`git switch master`（失敗時は `git checkout master`）
2. 作業ブランチを `master` にマージする：`git merge --no-ff <branch-name>`
3. `origin` が設定されている場合のみ `master` を push する：`git push origin master`
4. マージまたは push に失敗した場合はエラー内容を報告して終了する（タスクを完了扱いにしない）

### 5-B. PR必須（owner!=ebijun1007）の場合

1. ブランチをリモートに push する：`git push -u origin <branch-name>`
2. `gh pr create` で PR を作成する
3. push または PR 作成に失敗した場合はエラー内容を報告し、コミットは保持したまま終了する

### 6. 後続タスク・懸念事項

- DEFERRED: `.design/non-blocking-issues.md` に追記
- 新規タスク: **ユーザー確認の上**、`.design/tasks/YYYYMMDD-title.md` で起票（テンプレートは `.design/tasks/README.md` に準拠）

### 7. 完了報告

- 対象タスク名、コミット要約、実行分岐（`master` マージ or PR作成）と結果、QUICK-FIX/DEFERRED/後続タスクの一覧を報告

## Guardrails

- BLOCKING問題がある場合はファイル変更・コミットを行わない
- コミット失敗時はタスクステータスを更新しない
- 新規タスクの自動起票は禁止（必ずユーザー確認）
