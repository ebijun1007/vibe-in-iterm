---
description: 着手中タスクのセルフレビュー・コミット・完了処理を一括で行うコマンド
---

あなたはタスク完了オーケストレーターです。
現在着手中のタスクに対して、セルフレビュー → コミット（タスク更新含む） → 必要に応じた後続タスク起票を一連で行います。

## Step 1: 着手中タスクの特定

1. `.design/tasks/` フォルダ内の `YYYYMMDD-*.md` ファイル（`README.md` を除く）を走査する
2. `## ステータス` セクション内で `[x] 進行中` を含むファイルを検索する
3. 結果に応じて分岐：
   - **0件**: 「進行中のタスクが見つかりません」と報告して終了
   - **1件**: そのタスクを対象にする
   - **複数件**: ユーザーに選択を促す

## Step 2: 変更内容の把握

1. `git status` と `git diff`（staged + unstaged）で現在の変更ファイルを確認する
2. `git log` で直近のコミット履歴を確認する
3. タスクの完了条件・概要と照らし合わせ、このタスクに関連する変更を特定する

## Step 3: セルフレビュー

変更差分に対して `/commit` コマンドと同等の品質基準でレビューを行う：

- **correctness** / **tests** / **design** / **style** の4観点
- 設計ドキュメント（`.design/architecture.md`、`.design/guidelines.md`）との整合性を確認
- Codex MCP が利用可能な場合はレビュー時に併用する

結果を以下に分類する：

- **BLOCKING**: コミット前に修正が必要 → **コミットしない**。問題を報告して終了
- **QUICK-FIX**: 小規模（数行）で局所的、リスク低 → この場で修正してからコミット
- **DEFERRED**: 大規模 or 横断的影響 → `.design/non-blocking-issues.md` に記録

**BLOCKINGが1つでもある場合、以降のステップに進まない。**

## Step 4: コミット（タスク更新を含む）

1. QUICK-FIX がある場合は先に修正を適用する
2. タスクファイルのステータスを「完了」に更新する：
   - `[x] 進行中` → `[ ] 進行中`
   - `[ ] 完了` → `[x] 完了`
   - 達成済みの完了条件にチェックを入れる
3. タスク関連の変更ファイル **＋ タスクファイル自体** をまとめてステージする（`git add .` や `git commit -a` は禁止）
4. HEREDOC形式で **単一コミット** として実行する：

```bash
git add <files...> <task-file> && \
git commit -m "$(cat <<'EOF'
短い要約

- 詳細1
- 詳細2

Co-Authored-By: Claude <noreply@anthropic.com>
EOF
)"
```

5. リモートへの push は行わない

## Step 5: 後続タスク・懸念事項の処理

レビュー中に発見した事項について：

1. **DEFERRED 項目**: `.design/non-blocking-issues.md` に追記する
2. **新規タスクが必要な場合**: ユーザーに確認の上、`.design/tasks/YYYYMMDD-title.md` 形式で起票する
   - テンプレートは `.design/tasks/README.md` に従う
   - **ユーザーの承認なしに自動起票しない**

## Step 6: 完了報告

以下を簡潔に報告する：

- 対象タスク名
- コミット内容の要約
- QUICK-FIX で修正した項目（あれば）
- DEFERRED として記録した項目（あれば）
- 起票した後続タスク（あれば）

## 注意事項

- このコマンドはリモートへ push しない
- BLOCKING問題がある場合は修正を報告するのみで、ファイル変更やコミットは行わない
- コミット失敗時はタスクステータスを更新しない（整合性の維持）
