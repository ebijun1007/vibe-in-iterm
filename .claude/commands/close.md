---
description: 着手中タスクの Codex レビュー・ブランチ作成・コミット・PR 作成・完了処理を一括で行うコマンド
---

あなたはタスク完了オーケストレーターです。
現在着手中のタスクに対して、Codex MCP レビュー → ブランチ作成 & コミット → PR 作成 → 必要に応じた後続タスク起票を一連で行います。

## Step 1: 着手中タスクの特定

1. **会話ログを確認**し、この会話セッション中に `/pick` や `/work` で着手したタスク、またはユーザーが言及・作業していたタスクを特定する
2. 会話ログから特定できない場合は、ユーザーにどのタスクを完了させるか確認する
3. 対象タスクの `.design/tasks/YYYYMMDD-*.md` ファイルを読み込み、完了条件を把握する

## Step 2: 対象ファイルの特定

1. **会話ログから、自分がこのセッション中に作成・編集したファイルの一覧を確認する**
2. そのファイル一覧のみを対象とする。他の並行作業による差分は**無視する**
3. `git diff` は対象ファイルに絞って確認する（例: `git diff -- <file1> <file2> ...`）
4. 対象外のファイルについて確認や言及をしない。止まらずに進める

## Step 3: Codex MCP レビュー（必須ゲート）

対象ファイルの diff を Codex MCP に送信してレビューを依頼する。

1. `git diff -- <対象ファイル>` の出力を取得する
2. Codex MCP (`mcp__codex__codex`) を呼び出し、diff の内容と変更の意図を送信してレビューを依頼する
3. Codex MCP のレビュー結果を以下に分類する：
   - **BLOCKING**: コミット前に修正が必要 → 修正して **再度 Codex MCP レビューを実施**（ループ）
   - **QUICK-FIX**: 小規模（数行）で局所的、リスク低 → この場で修正
   - **DEFERRED**: 大規模 or 横断的影響 → `.design/non-blocking-issues.md` に記録
4. **Codex MCP レビュー通過が必須**。BLOCKING が解消されるまで次のステップに進まない

### Codex MCP が利用不可能な場合

Codex MCP に接続できない・タイムアウトした場合は、**ユーザーに確認**する：
- セルフレビュー（correctness / tests / design / style の4観点）で代替するか
- Codex MCP の復旧を待つか

**ユーザーの明示的な承認なしにレビューをスキップしてはならない。**

## Step 4: ブランチ作成 & コミット

### 4-1: ブランチ作成

1. 現在のブランチを確認する（`git branch --show-current`）
2. **デフォルトブランチ（master または main）にいる場合**：タスク名ベースのブランチを作成する
   - 形式: `task/YYYYMMDD-task-slug`（タスクファイル名から生成）
   - 例: `task/20260217-update-close-command`
   - `git checkout -b <branch-name>` で作成
3. **既にタスク用ブランチにいる場合**：そのまま使用する
4. **ブランチ作成に失敗した場合**：以降のステップに進まない。エラーを報告して終了する

### 4-2: QUICK-FIX 修正 & タスクステータス更新 & コミット

以下を順番に行い、**単一コミット** にまとめる。コミットが失敗した場合、タスクは完了扱いにしない（ファイル変更は未コミットのまま残る）。

1. QUICK-FIX がある場合は先に修正を適用する
2. タスクファイルのステータスを「完了」に更新する：
   - `[x] 進行中` → `[ ] 進行中`
   - `[ ] 完了` → `[x] 完了`
   - 達成済みの完了条件にチェックを入れる
3. タスク関連の変更ファイル **＋ タスクファイル自体** をまとめてステージする（`git add .` や `git commit -a` は禁止）
4. HEREDOC形式でコミットする：

```bash
git add <files...> <task-file> && \
git commit -m "$(cat <<'EOF'
短い要約

- 詳細1
- 詳細2

Co-Authored-By: Claude <noreply@anthropic.com>
EOF
)"
```

## Step 5: PR 作成

1. ブランチをリモートに push する：`git push -u origin <branch-name>`
2. `gh pr create` で PR を作成する：
   - **タイトル**: タスク名（簡潔に）
   - **本文**: 変更要約（HEREDOC 形式で渡す）

```bash
gh pr create --title "タスク名" --body "$(cat <<'EOF'
## Summary
- 変更内容の要約

## Task
- `.design/tasks/YYYYMMDD-task-name.md`

Co-Authored-By: Claude <noreply@anthropic.com>
EOF
)"
```

3. **push または PR 作成に失敗した場合**：
   - エラー内容を報告する
   - コミット自体は保持される（ローカルに残る）
   - ユーザーに手動対応を依頼する

## Step 6: 後続タスク・懸念事項の処理

レビュー中に発見した事項について：

1. **DEFERRED 項目**: `.design/non-blocking-issues.md` に追記する
2. **新規タスクが必要な場合**: ユーザーに確認の上、`.design/tasks/YYYYMMDD-title.md` 形式で起票する
   - テンプレートは `.design/tasks/README.md` に従う
   - **ユーザーの承認なしに自動起票しない**

## Step 7: 完了報告

以下を簡潔に報告する：

- 対象タスク名
- コミット内容の要約
- **PR の URL**（作成成功時）/ PR 作成失敗の旨（失敗時）
- QUICK-FIX で修正した項目（あれば）
- DEFERRED として記録した項目（あれば）
- 起票した後続タスク（あれば）

## 注意事項

- BLOCKING問題がある場合は修正して再レビュー。解消するまでコミットしない
- ブランチ作成失敗時は以降のステップに進まない
- コミット失敗時はタスクを完了扱いにしない（ファイル変更は未コミットのまま残るので、原因を報告して終了する）
- Codex MCP レビューのスキップにはユーザーの明示的承認が必要
