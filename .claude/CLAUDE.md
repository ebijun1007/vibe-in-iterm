* ファイルの作成・更新やプログラムの実行を行う前に、必ずplanモードで計画を立てた後、 codex exec を使用してレビューを行い、現在のタスクに基づいて作業計画を作成または更新すること。
* 実装作業の開始**直前**と完了**直後**に codex exec を実行し、事前・事後レビューとして変更内容の検証と要約を行うこと。
* コード実装時は `git worktree` を使い、タスクごとに独立した作業空間で作業してコンフリクトを回避すること。
## 既存コード再利用ルール（必須）

関数・ユーティリティ・ヘルパー・型定義を新規実装する前に、既存のコードベースに再利用可能なものがないか必ず調査すること。本当に存在しない場合にのみ新規実装する。

## フォールバック実装の禁止（必須）

データソースのフィールドマッピングや外部APIとの連携において、推測に基づくフォールバック（複数のキー候補を順番に試す等）を実装してはならない。正しいフィールド名・キー名が不明な場合は、ドキュメント・スキーマ・型定義を調査して正確なマッピングを特定すること。特定できない場合はユーザーに確認を求める。

### 調査手順

1. **Explore サブエージェントで調査する**: Task ツール（`subagent_type: "Explore"`）を使い、実装しようとしている機能に関連するキーワード・関数名・型名でコードベースを検索する。検索は `"very thorough"` レベルで実施する。
2. **調査観点**: 以下を重点的に確認する：
   - 同名・類似名の関数やクラス
   - 同等のロジックを持つユーティリティ（`utils/`, `libs/`, `helpers/`, `domain/` など）
   - 共有パッケージ（`packages/core` など）に既に定義されている型・スキーマ・ヘルパー
   - 同じ外部ライブラリの既存ラッパー
3. **判断と行動**:
   - **既存コードが見つかった場合** → そのまま再利用するか、必要に応じて拡張する
   - **類似だが不十分な場合** → 既存コードを拡張・リファクタリングして対応する（新規ファイル作成より優先）
   - **見つからなかった場合** → 新規実装してよい。ただし配置場所は既存のディレクトリ構造・命名規則に従う

## プロジェクトドキュメント

`.design/` ディレクトリにプロジェクトの設計ドキュメントが格納されています：

- `granddesign.md` - プロジェクトの全体設計
- `architecture.md` - アーキテクチャ設計
- `decisions.md` - 意思決定記録（ADR）
- `guidelines.md` - 開発ガイドライン
- `non-blocking-issues.md` - 非ブロッキング課題
- `tasks/` - タスク管理フォルダ

## タスク管理

### owner フィールド
タスクファイル（`.design/tasks/*.md`）の frontmatter `owner` で担当エージェントが指定される。
- `codex` — Codex が担当（sandbox内、限定変更）
- `claude-code` — Claude Code が担当（フル機能）
- 空 — 未トリアージ

### Claude Code の振る舞い
- `owner: codex` のタスクは実装しない（ユーザーが明示的に指示した場合を除く）
- `owner: claude-code` のタスクに着手可能
- `owner` が空のタスクを見つけた場合、まず AGENTS.md のトリアージ基準に従い owner を設定してから着手する
- タスク作成時は AGENTS.md のトリアージ基準に従い owner を必ず設定する
